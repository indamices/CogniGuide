import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), '');

  return {
    plugins: [
      react({
        // Fast Refresh优化
        fastRefresh: true,
        // 启用React的自动JSX运行时导入
        jsxImportSource: 'react',
        babel: {
          plugins: [
            // 启用babel插件优化
            ['babel-plugin-react-hot-loader', { disable: mode === 'production' }]
          ]
        }
      })
    ],
    define: {
      'process.env.API_KEY': JSON.stringify(env.API_KEY || ''),
    },

    // 构建优化
    build: {
      // 代码分割策略
      rollupOptions: {
        output: {
          // 手动代码分割
          manualChunks: {
            // React核心库单独打包
            'react-vendor': ['react', 'react-dom'],
            // D3可视化库单独打包
            'd3-vendor': ['d3'],
            // Markdown相关库单独打包
            'markdown-vendor': [
              'react-markdown',
              'rehype-highlight',
              'remark-math',
              'rehype-katex'
            ],
            // AI SDK单独打包
            'ai-vendor': ['@google/genai']
          },
          // 输出文件命名（带hash便于缓存）
          chunkFileNames: 'assets/js/[name]-[hash].js',
          entryFileNames: 'assets/js/[name]-[hash].js',
          assetFileNames: 'assets/[ext]/[name]-[hash].[ext]'
        }
      },
      // 压缩配置
      minify: 'terser',
      terserOptions: {
        compress: {
          // 移除console
          drop_console: mode === 'production',
          // 移除debugger
          drop_debugger: mode === 'production',
          // 死代码消除
          pure_funcs: mode === 'production' ? ['console.log', 'console.info'] : []
        },
        format: {
          // 移除注释
          comments: false
        }
      },
      // chunk大小警告阈值
      chunkSizeWarningLimit: 1000,
      // CSS代码分割
      cssCodeSplit: true,
      // sourcemap配置
      sourcemap: mode === 'development' ? 'eval' : false,
      // 目标浏览器
      target: 'es2015'
    },

    // 开发服务器优化
    server: {
      // 预构建频繁使用的依赖
      optimizeDeps: {
        include: [
          'react',
          'react-dom',
          'react-markdown',
          'd3',
          '@google/genai'
        ],
        // 排除不需要预构建的包
        exclude: []
      },
      // HMR配置
      hmr: {
        overlay: true
      },
      // 端口
      port: 3000,
      // 自动打开浏览器
      open: true
    },

    // 预览服务器优化
    preview: {
      port: 4173,
      open: true
    },

    // 依赖优化
    optimizeDeps: {
      // 强制预构建
      force: false,
      // 包含的依赖
      include: [
        'react',
        'react-dom',
        'react-markdown',
        'rehype-highlight',
        'remark-math',
        'rehype-katex',
        'd3',
        '@google/genai'
      ]
    },

    // CSS配置
    css: {
      modules: {
        // CSS模块本地作用域模式
        localsConvention: 'camelCase'
      },
      // 开发环境使用sourcemap
      devSourcemap: true
    },

    // 性能优化
    esbuild: {
      // 生产环境移除console
      drop: mode === 'production' ? ['console', 'debugger'] : [],
      // 目标环境
      target: 'es2015',
      // JSX转换
      jsx: 'automatic'
    }
  };
});
